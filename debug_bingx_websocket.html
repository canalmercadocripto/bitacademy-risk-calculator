<!DOCTYPE html>
<html>
<head>
    <title>Debug BingX WebSocket</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        .warning { background: #fff3cd; }
        .info { background: #e6f3ff; }
        button { padding: 10px 20px; margin: 5px; }
        #logs { max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug BingX WebSocket</h1>
    <button onclick="testBingXWebSocket()">Test BingX WebSocket</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>
    
    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function testBingXWebSocket() {
            log('üöÄ Testing BingX WebSocket...', 'info');
            
            const wsUrl = 'wss://open-api-ws.bingx.com/market';
            log(`üåê Connecting to: ${wsUrl}`, 'info');
            
            try {
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('‚úÖ WebSocket connected successfully', 'success');
                    
                    // Enviar mensagem de subscri√ß√£o
                    const subscribeMessage = {
                        id: Date.now(),
                        reqType: 'sub',
                        dataType: 'BTC-USDT@kline_1m'
                    };
                    
                    ws.send(JSON.stringify(subscribeMessage));
                    log(`üì° Subscription sent: ${JSON.stringify(subscribeMessage)}`, 'info');
                };
                
                ws.onmessage = async (event) => {
                    log(`üì• Message received (type: ${typeof event.data})`, 'info');
                    
                    if (event.data instanceof Blob) {
                        log(`üì¶ Blob data received (size: ${event.data.size} bytes)`, 'warning');
                        
                        try {
                            // Tentar converter Blob para ArrayBuffer
                            const arrayBuffer = await event.data.arrayBuffer();
                            const uint8Array = new Uint8Array(arrayBuffer);
                            
                            log(`üìä ArrayBuffer size: ${arrayBuffer.byteLength} bytes`, 'info');
                            log(`üìä First 20 bytes: ${Array.from(uint8Array.slice(0, 20)).map(b => b.toString(16).padStart(2, '0')).join(' ')}`, 'info');
                            
                            // Verificar se √© GZIP (magic bytes: 1f 8b)
                            if (uint8Array[0] === 0x1f && uint8Array[1] === 0x8b) {
                                log('üóúÔ∏è GZIP compression detected', 'warning');
                                
                                // Tentar descomprimir com DecompressionStream
                                if (typeof DecompressionStream !== 'undefined') {
                                    try {
                                        const stream = new DecompressionStream('gzip');
                                        const writer = stream.writable.getWriter();
                                        const reader = stream.readable.getReader();
                                        
                                        writer.write(uint8Array);
                                        writer.close();
                                        
                                        const result = await reader.read();
                                        const decompressed = new TextDecoder().decode(result.value);
                                        log(`‚úÖ Decompressed: ${decompressed}`, 'success');
                                        
                                        const data = JSON.parse(decompressed);
                                        log(`üìä Parsed data: ${JSON.stringify(data, null, 2)}`, 'success');
                                    } catch (error) {
                                        log(`‚ùå GZIP decompression failed: ${error.message}`, 'error');
                                    }
                                } else {
                                    log('‚ùå DecompressionStream not available', 'error');
                                }
                            } else {
                                // Tentar interpretar como texto direto
                                const text = new TextDecoder().decode(uint8Array);
                                log(`üìù Raw text: ${text}`, 'info');
                                
                                try {
                                    const data = JSON.parse(text);
                                    log(`üìä Parsed JSON: ${JSON.stringify(data, null, 2)}`, 'success');
                                } catch (error) {
                                    log(`‚ùå JSON parse failed: ${error.message}`, 'error');
                                }
                            }
                            
                        } catch (error) {
                            log(`‚ùå Error processing Blob: ${error.message}`, 'error');
                        }
                    } else {
                        log(`üìù Text data: ${event.data}`, 'info');
                        try {
                            const data = JSON.parse(event.data);
                            log(`üìä Parsed JSON: ${JSON.stringify(data, null, 2)}`, 'success');
                        } catch (error) {
                            log(`‚ùå JSON parse failed: ${error.message}`, 'error');
                        }
                    }
                };
                
                ws.onerror = (error) => {
                    log(`‚ùå WebSocket error: ${error}`, 'error');
                };
                
                ws.onclose = (event) => {
                    log(`üîï WebSocket closed: ${event.code} - ${event.reason}`, 'warning');
                };
                
                // Fechar conex√£o ap√≥s 30 segundos
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        log('‚è∞ Connection closed after 30 seconds', 'info');
                    }
                }, 30000);
                
            } catch (error) {
                log(`üí• WebSocket creation failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-start test
        window.onload = () => {
            log('üîß BingX WebSocket Debug Tool Ready', 'info');
            log('Click "Test BingX WebSocket" to start testing...', 'info');
        };
    </script>
</body>
</html>